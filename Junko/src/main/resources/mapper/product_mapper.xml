<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.junko.product.ProductDAO">

<!-- 상품 등록 -->
	<insert id="productInsert" parameterType="kr.co.junko.dto.ProductDTO"
	        useGeneratedKeys="true" keyProperty="product_idx">
	    INSERT INTO product (
	        product_name, purchase_price, selling_price, discount_rate, product_standard, category_idx
	    ) 
	    VALUES (
	        #{product_name}, #{purchase_price}, #{selling_price}, #{discount_rate}, #{product_standard}, #{category_idx}
	    )
	</insert>

<!-- 상품 이미지 등록 -->
	<insert id="fileWrite" parameterType="kr.co.junko.dto.FileDTO">
	    INSERT INTO file (ori_filename, new_filename, idx, type)
	    VALUES (#{ori_filename}, #{new_filename}, #{idx}, #{type})
	</insert>

<!-- 상품 이미지 조회 -->
	<update id="productUpdate" parameterType="kr.co.junko.dto.ProductDTO">
		UPDATE product
		<trim prefix="SET" suffixOverrides=",">
			<if test="product_name != null and product_name != ''">
				product_name = #{product_name},
			</if>
			<if test="purchase_price != null and purchase_price != 0">
				purchase_price = #{purchase_price},
			</if>
			<if test="selling_price != null and selling_price != 0">
				selling_price = #{selling_price},
			</if>
			<if test="discount_rate != null">
				discount_rate = #{discount_rate},
			</if>
			<if test="product_standard != null and product_standard != ''">
				product_standard = #{product_standard},
			</if>
			<if test="category_idx != null and category_idx != 0">
				category_idx = #{category_idx},
			</if>
		</trim>
		WHERE product_idx = #{product_idx}
	</update>

<!-- 상품 이미지 삭제 -->
	<update id="softDelProductImg" parameterType="int">
		UPDATE file
		SET del_yn = 1
		WHERE idx = #{product_idx}
		AND type = 'product'
		AND del_yn = 0
	</update>

<!-- 상품 삭제 -->
	<update id="softDelProduct" parameterType="int">
		UPDATE product
		SET del_yn = 1
		WHERE product_idx = #{product_idx}
	</update>

<!-- 상품 목록 조회 -->
	<select id="productList" resultType="kr.co.junko.dto.ProductDTO">
		SELECT *
		FROM product
		WHERE del_yn = '0'
		<if test="search != null and search != ''">
			AND (product_name LIKE CONCAT('%', #{search}, '%')
				OR product_idx LIKE CONCAT('%', #{search}, '%'))
		</if>
		<if test="category != 0">
			AND category_idx = #{category}
		</if>
		ORDER BY 
			<choose>
				<when test="sort == 'price_asc'">selling_price ASC</when>
				<when test="sort == 'price_desc'">selling_price DESC</when>
				<otherwise>product_idx DESC</otherwise>
			</choose>
		LIMIT #{start}, #{size}
	</select>

<!-- 상품 총 개수 조회 -->
	<select id="productTotalCnt" resultType="int">
		SELECT COUNT(*)
		FROM product
		WHERE del_yn = '0'
		<if test="search != null and search != ''">
			AND (product_name LIKE CONCAT('%', #{search}, '%')
				OR product_idx LIKE CONCAT('%', #{search}, '%'))
		</if>
		<if test="category != 0">
			AND category_idx = #{category}
		</if>
	</select>

</mapper>