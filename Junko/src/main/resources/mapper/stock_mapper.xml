<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.junko.stock.StockDAO">

	<select id="stockInfo" resultType="map">
		SELECT rp.product_idx, rp.product_option_idx,rp.receive_cnt, o.warehouse_idx, c.lot_require
		from receive r 
		join receive_product rp on r.receive_idx = rp.receive_idx 
		join `order` o on r.order_idx = o.order_idx 
		join product p on rp.product_idx = p.product_idx
		join category c on p.category_idx = c.category_idx
		where r.receive_idx = #{param1}
	</select>

	<insert id="stockInsert" parameterType="kr.co.junko.dto.StockDTO">
		insert into stock (product_idx,stock_cnt, zone_idx, type, user_idx, warehouse_idx
		<if test="product_option_idx != null and product_option_idx != 0">
			,product_option_idx
		</if>
		<if test="manufacture != null">
			,manufacture
		</if>
		<if test="expiration != null">
			,expiration
		</if>
		)
		values (#{product_idx},#{stock_cnt},#{zone_idx},#{type},#{user_idx}, #{warehouse_idx}
		<if test="product_option_idx != null and product_option_idx != 0">
			,#{product_option_idx}
		</if>
		<if test="manufacture != null">
			,#{manufacture}
		</if>
		<if test="expiration != null">
			,#{expiration}
		</if>
		)
	</insert>
	
	<select id="stockDetailByIdx" resultType="kr.co.junko.dto.StockDTO">
		select * from stock where stock_idx = #{stock_idx}
	</select>
	
	<!-- 출고 시 선택 할 때 보여지는 리스트 -->
	<select id="shipStockList">
		select 
			s.product_idx,
			p.product_name,
			s.product_option_idx,
			c.combined_name ,
			sum(stock_cnt) as stock,
			s.manufacture,
			s.expiration,
			s.warehouse_idx, 
			s.zone_idx 
		from stock s 
		join product p on p.product_idx = s.product_idx
		left join product_option po on po.product_idx = s.product_idx
		left join combined c on c.combined_idx = po.combined_idx
		<where>
			del_yn = false
			<if test="warehouse_idx != null and warehouse_idx != 0">
				and s.warehouse_idx = #{warehouse_idx}
			</if>
			<if test="product_idx != null and product_idx != 0">
				and s.product_idx = #{product_idx}
			</if>
			<if test="product_option_idx != null and product_option_idx != 0">
				and s.product_option_idx = #{product_option_idx}
			</if>
		</where>
		group by 
			s.product_idx,
			s.product_option_idx, 
			s.manufacture , 
			s.expiration ,
			s.warehouse_idx,
			s.zone_idx
		having
			sum(stock_cnt)>0
	</select>
	
</mapper>